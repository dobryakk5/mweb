# Views Tracking Scheduler

Сервис для ежедневного отслеживания просмотров объявлений.

## Стратегия отслеживания

- **CIAN**: Отслеживаем ВСЕ объявления
- **Avito/Yandex**: Отслеживаем только объявления в таблице сравнения (`sma = 1`)

## Расписание

- **Продакшн**: Каждый день в 23:00 (московское время)
- **Разработка**: Тестовый запуск через 5 секунд после старта

## Типы записей в истории

- `daily_snapshot` - ежедневный снимок просмотров в 23:00
- `manual_update` - ручное обновление через API  
- `parsing_update` - обновление при парсинге объявления

## Команды

```bash
# Разработка
pnpm dev

# Продакшн
pnpm build && pnpm start
```

## Логика работы

1. Получаем все объявления из БД
2. Фильтруем по стратегии (CIAN все, остальные только в сравнении)  
3. Для каждого объявления:
   - Парсим текущие просмотры с сайта
   - Сравниваем с предыдущими значениями
   - Записываем изменения в `ad_history` с типом `daily_snapshot`
   - Обновляем основную таблицу `ads`
   - Делаем паузу 2 секунды между запросами

## TODO

- [ ] Реализовать реальный парсинг для каждого сайта вместо заглушек
- [ ] Добавить обработку ошибок сети и блокировок
- [ ] Добавить метрики и мониторинг
- [ ] Настроить логирование в файл