# API Service

Сервис API для работы с недвижимостью, включая парсинг данных из объявлений.

## Функциональность

### Парсинг недвижимости
- **`GET /property/parse?url={url}`** - парсинг одного объявления по URL
- **`POST /properties/parse-urls`** - пакетный парсинг по массиву URL
- **`POST /properties/parse-text`** - парсинг недвижимости из текста
- **`POST /properties/parse-with-retry`** - парсинг с retry логикой
- **`GET /health`** - проверка состояния Python API

### Другие эндпоинты
- **`/ads`** - управление объявлениями
- **`/users`** - управление пользователями
- **`/user-flats`** - управление квартирами пользователей

## Настройка

### Переменные окружения

Создайте файл `.env` в корне `services/api/`:

```env
# Порт для API сервиса
PORT=13001

# URL Python API для парсинга недвижимости
PYTHON_API_URL=http://localhost:8008

# Настройки базы данных
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
```

### Python API

Для работы парсинга недвижимости требуется запущенный Python API сервис на порту 8008.

API должен поддерживать следующие эндпоинты:
- `POST /parse` - парсинг одного объявления
- `POST /parse-batch` - пакетный парсинг
- `POST /parse-text` - парсинг из текста
- `GET /health` - проверка состояния

### Запуск

```bash
# Установка зависимостей
pnpm install

# Запуск в режиме разработки
pnpm dev

# Сборка
pnpm build

# Запуск продакшена
pnpm start
```

## Интеграция с фронтендом

Фронтенд настроен на работу с API через переменную окружения `NEXT_PUBLIC_API_URL`.

В файле `apps/web/.env.local`:
```env
NEXT_PUBLIC_API_URL=http://localhost:13001
```

## Структура проекта

```
src/
├── routes/           # Роуты API
│   ├── property-parser.ts  # Парсинг недвижимости
│   ├── ads.ts        # Объявления
│   ├── users.ts      # Пользователи
│   └── user-flats.ts # Квартиры пользователей
├── plugins/          # Плагины Fastify
├── server.ts         # Основной файл сервера
└── types.d.ts        # Типы TypeScript
```

## Логирование

API использует Pino для логирования. В режиме разработки логи форматируются через `pino-pretty`.

## Обработка ошибок

Все эндпоинты возвращают стандартизированные ответы:
- `200` - успешный ответ
- `400` - ошибка валидации
- `500` - внутренняя ошибка сервера
- `503` - сервис недоступен (для health check)
