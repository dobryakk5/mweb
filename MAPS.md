# Карты - Документация

## Обзор системы карт

Система карт позволяет пользователям визуализировать объявления о недвижимости на интерактивной карте с различными маркерами и фильтрацией.

## Архитектура данных

### Основные таблицы

1. **`public.flats_history`** - основная таблица с объявлениями
   - `house_id` - ID дома для группировки по зданиям
   - `lat`, `lng` - координаты объявления
   - `is_actual` - статус активности (1 = активное, 0 = неактивное)
   - `price`, `rooms`, `floor`, `area` - основные характеристики
   - `url` - ссылка на источник объявления

2. **`system.moscow_geo`** - геоданные домов Москвы
   - `house_id` - связка с flats_history
   - `street`, `housenum` - адресные данные
   - `centroid_utm` - координаты в UTM проекции
   - `building` - тип здания (для POI)

3. **`users.user_flats`** - квартиры пользователей
   - `address` - адрес квартиры пользователя
   - Используется для определения центральной точки карты

## API Endpoints

### `/map/houses-in-bounds`
Получение домов с объявлениями в заданных границах карты.

**Параметры:**
- `north`, `south`, `east`, `west` - границы карты
- `flatId` - ID квартиры пользователя (для исключения совпадений)

**Логика:**
1. Получает адрес текущей квартиры из `users.user_flats`
2. Вызывает `public.get_houses_with_ads_by_coordinates()`
3. Фильтрует дома в пределах границ
4. **ИСКЛЮЧАЕТ дома по тому же адресу**, что и текущая квартира
5. Добавляет счетчик активных объявлений

### `/map/address-coordinates`
Получение координат по адресу из `system.moscow_geo`.

### `/map/house-ads`
Получение объявлений конкретного дома из `public.flats_history`.

### `/map/poi`
Получение точек интереса (школы, детсады) из `system.moscow_geo`.

## Типы маркеров на карте

### 1. Красный маркер - Текущая квартира
- Координаты получаются через `/map/address-coordinates`
- Отображает местоположение квартиры пользователя
- Всегда показан поверх остальных маркеров

### 2. Оранжевые маркеры - Дома с активными объявлениями
- `has_active_ads: true`
- `active_ads_count > 0`
- Кликабельные - показывают список объявлений дома

### 3. Серые маркеры - Дома только с неактивными объявлениями
- `has_active_ads: false`
- `active_ads_count = 0`
- Менее приоритетные, но все еще полезные


## Предотвращение наложения маркеров

### Проблема
Оранжевые маркеры домов могут накладываться на красный маркер текущей квартиры, если они находятся по одному адресу.

### Решение (API-level)
1. **В API endpoint `/map/houses-in-bounds`:**
   ```sql
   -- Получаем адрес текущей квартиры
   SELECT address FROM users.user_flats WHERE id = ${flatId}

   -- Исключаем дома с тем же адресом
   WHERE house.address !== currentFlatAddress
   ```

2. **Преимущества API-level фильтрации:**
   - Логика централизована
   - Меньше данных передается на фронтенд
   - Лучшая производительность
   - Проще тестировать и поддерживать

## Компоненты фронтенда

### `NearbyMapComponent`
Основной компонент карты с Leaflet.

**Ключевые особенности:**
- Динамическая загрузка домов при изменении границ карты
- Автоматическое получение координат адреса
- Разные иконки для разных типов маркеров
- Легенда для объяснения типов маркеров

### `NearbyMap`
Wrapper компонент с поддержкой:
- Server-side rendering (SSR) совместимости
- Клика по домам и загрузки объявлений
- Состояния загрузки

## Workflow работы с картой

1. **Инициализация:**
   - Загружается адрес квартиры пользователя
   - Получаются координаты через `/map/address-coordinates`
   - Устанавливается центр карты

2. **Загрузка домов:**
   - При изменении границ карты вызывается `/map/houses-in-bounds`
   - API исключает дома по адресу текущей квартиры
   - Отображаются маркеры с правильными иконками

3. **Интерактивность:**
   - Клик по дому → загрузка объявлений через `/map/house-ads`
   - Отображение деталей в боковой панели
   - Возможность перехода к объявлениям

## Производительность

### Оптимизации
- Лимит на количество домов (500)
- Кэширование координат адресов
- Debounce для изменений границ карты
- Ограничение объявлений из таблицы (20 шт)

### Мониторинг
- Логирование исключенных домов
- Счетчики запросов в API
- Отслеживание времени ответа

## Известные ограничения

1. **Точность координат:** Координаты из разных источников могут иметь разную точность
2. **Кэширование:** Изменения в базе могут не сразу отражаться на карте
3. **Масштабирование:** При большом количестве объявлений может быть медленно

## Развитие

### Планируемые улучшения
- Кластеризация маркеров при большом количестве
- Фильтрация по цене/комнатам прямо на карте
- Сохранение позиции карты в localStorage
- Поддержка мобильных устройств