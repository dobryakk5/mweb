# –ö–∞—Ä—Ç—ã - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ä—Ç

–°–∏—Å—Ç–µ–º–∞ –∫–∞—Ä—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

  1. –ë–ª–æ–∫ "–ú–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞" ‚Üí –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑–∫—É (house_id, floor, rooms)
  2. –¢–∞–±–ª–∏—Ü–∞ public.flats ‚Üí —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ —Å–≤—è–∑–∫–µ (house_id, floor, rooms)
  3. –¢–∞–±–ª–∏—Ü–∞ flats_history ‚Üí —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
  4. Python API –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –ë–î

–ü—Ä–æ—Ü–µ—Å—Å API:

  1. API endpoint /map/flat-full-data/:flatId –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã
  2. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –ø–ª–æ—â–∞–¥–∏ –≤ public.flats —á–µ—Ä–µ–∑ —Å–≤—è–∑–∫—É (house_id, floor, rooms)
  3. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ - –∑–∞–ø—É—Å–∫–∞–µ—Ç fallback:
    - –ù–∞—Ö–æ–¥–∏—Ç cian URL –¥–ª—è —Ç–æ–π –∂–µ —Å–≤—è–∑–∫–∏ –≤ public.flats_history
    - –í—ã–∑—ã–≤–∞–µ—Ç Python API: GET {PYTHON_API_URL}/api/parse/single?url={cianUrl}
    - –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç area, kitchen_area, total_floors
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ public.flats —Å ON CONFLICT DO UPDATE

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### ‚ö†Ô∏è –í–ê–ñ–ù–û: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ä–æ–ª—å house_id

**–ì–ª–∞–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–∏—Å—Ç–µ–º—ã - `house_id`**. –í—Å—ë –∫ –Ω–µ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω–æ:

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ house_id –ø–æ –∞–¥—Ä–µ—Å—É**:
   ```sql
   SELECT house_id FROM "system".moscow_geo
   WHERE centroid_utm = point AND street = '...' AND housenum = '...'
   ```

2. **–í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–º–∞ –≤ PostGIS —Å—Ö–µ–º–µ `system`**:
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä–æ–∏–¥—É (`centroid_utm`)
   - PostGIS —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ UTM ‚Üí WGS84
   - –í—Å–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `system.moscow_geo`

3. **–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ house_id**:
   - –°—Ö–µ–º–∞ `public.flats_history` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ `house_id`
   - –ù–ï–¢ –ø—Ä—è–º—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ `flats_history`
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JOIN —Å `system.moscow_geo`

4. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ house_id**:
   - –ú–∞—Ä–∫–µ—Ä—ã —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –ø–æ `centroid_utm` –∏–∑ `system.moscow_geo`
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ `house_id`
   - –û–¥–∏–Ω –º–∞—Ä–∫–µ—Ä = –æ–¥–∏–Ω –¥–æ–º = –æ–¥–∏–Ω `house_id`


5. **–§–ò–õ–¨–¢–†–´**:
    public.get_ads_in_bounds –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ä—Ç—ã —Å preview –ø–∞–Ω–µ–ª—å—é. –û–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞—Ä—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∫–≤–∞—Ä—Ç–∏—Ä—ã

  –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

  1. API endpoint: /map/ads-in-bounds –≤ services/api/src/routes/map.ts
  2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: useMapAdsFilter hook –¥–ª—è preview –ø–∞–Ω–µ–ª–∏
  3. –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–∞—Ä—Ç—ã —Å –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª—å—é –æ–±—ä—è–≤–ª–µ–Ω–∏–π

  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∏—Ö —Ä–æ–ª—å:

  - p_north, p_south, p_east, p_west - –≥—Ä–∞–Ω–∏—Ü—ã –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã (bounds)
  - p_rooms - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (‚â• –∫–æ–º–Ω–∞—Ç —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã)
  - p_max_price - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (< —Ü–µ–Ω—ã —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã)
  - p_min_area - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (90% –æ—Ç –ø–ª–æ—â–∞–¥–∏ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã)
  - p_min_kitchen_area - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏ (‚â• 90%–∫—É—Ö–Ω–∏ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã)

  –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

  1. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ–º –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –≥—Ä–∞–Ω–∏—Ü–∞–º —á–µ—Ä–µ–∑ PostGIS
  2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ preview –ø–∞–Ω–µ–ª–∏ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–∞—Ä—Ç—ã



### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

1. **`public.flats_history`** - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
   - `house_id` - **–ì–õ–ê–í–ù–´–ô** ID –¥–æ–º–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –∑–¥–∞–Ω–∏—è–º
   - ‚ö†Ô∏è **–ù–ï–¢ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç** - –æ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JOIN —Å `system.moscow_geo`
   - `is_actual` - —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (1 = –∞–∫—Ç–∏–≤–Ω–æ–µ, 0 = –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ)
   - `price`, `rooms`, `floor` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
   - `url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
   - `time_source_updated` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

2. **`system.moscow_geo`** - –≥–µ–æ–¥–∞–Ω–Ω—ã–µ –¥–æ–º–æ–≤ –ú–æ—Å–∫–≤—ã
   - `house_id` - —Å–≤—è–∑–∫–∞ —Å flats_history
   - `street`, `housenum` - –∞–¥—Ä–µ—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   - `centroid_utm` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ UTM –ø—Ä–æ–µ–∫—Ü–∏–∏
   - `building` - —Ç–∏–ø –∑–¥–∞–Ω–∏—è (–¥–ª—è POI)

3. **`users.user_flats`** - –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - `address` - –∞–¥—Ä–µ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∫–∞—Ä—Ç—ã

## API Endpoints

### –ê–∫—Ç–∏–≤–Ω—ã–µ endpoints

### `/map/houses-in-bounds`
–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–º–æ–≤ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –≤ –∑–∞–¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞—Ä—Ç—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `north`, `south`, `east`, `west` - –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
- `flatId` - ID –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–∑ `users.user_flats`
2. –í—ã–∑—ã–≤–∞–µ—Ç `public.get_houses_with_ads_by_coordinates()`
3. –§–∏–ª—å—Ç—Ä—É–µ—Ç –¥–æ–º–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥—Ä–∞–Ω–∏—Ü
4. **–ò–°–ö–õ–Æ–ß–ê–ï–¢ –¥–æ–º–∞ –ø–æ —Ç–æ–º—É –∂–µ –∞–¥—Ä–µ—Å—É**, —á—Ç–æ –∏ —Ç–µ–∫—É—â–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞
5. –î–æ–±–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π

### `/map/ads`
–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π - –∫–∞–∫ –¥–ª—è –æ–±–ª–∞—Å—Ç–µ–π –∫–∞—Ä—Ç—ã, —Ç–∞–∫ –∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ–º–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –æ–±–ª–∞—Å—Ç–∏: `north`, `south`, `east`, `west` - –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
- –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–º—É: `houseId` - ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–º–∞
- –û–±—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã: `rooms`, `maxPrice`, `minArea`, `minKitchenArea`, `limit`

### `/map/user-flats`
–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ.

### `/map/address-coordinates`
–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ –∞–¥—Ä–µ—Å—É –∏–∑ `system.moscow_geo`.

### `/map/address-to-house-id`
–ü–æ–ª—É—á–µ–Ω–∏–µ house_id –ø–æ –∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `get_house_id_by_address`.

### `/map/flat-full-data/:flatId`
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤–∫–ª—é—á–∞—è –ø–ª–æ—â–∞–¥–∏ –∏ —Ü–µ–Ω—ã —Å fallback –Ω–∞ Python API.

### `/map/update-ads-statuses`
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Python API –¥–ª—è CIAN –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –∑–∞–¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö.

### `/map/house-info/:houseId`
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–º–µ (–∞–¥—Ä–µ—Å, —Ç–∏–ø –¥–æ–º–∞) –ø–æ house_id.

### `/map/poi`
–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (—à–∫–æ–ª—ã, –¥–µ—Ç—Å–∞–¥—ã) –∏–∑ `system.moscow_geo`.

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ endpoints (—è–Ω–≤–∞—Ä—å 2025)

–í —Ö–æ–¥–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ API –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ endpoints:

- **`/map/houses-by-ids`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö house_id (–∑–∞–º–µ–Ω–µ–Ω –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
- **`/map/house-prices`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –¥–ª—è –¥–æ–º–æ–≤ (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `/map/ads`)
- **`/map/houses-coordinates`** - batch endpoint –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–æ–º–æ–≤ (–∑–∞–º–µ–Ω–µ–Ω –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- **`/map/house-ads`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–º–∞ (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ –≤ `/map/ads`)

–≠—Ç–∏ endpoints –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –≤–æ frontend –∏–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ endpoint `/map/ads`.

## –¢–∏–ø—ã –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ

### 1. –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä - –¢–µ–∫—É—â–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `/map/address-coordinates`
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω –ø–æ–≤–µ—Ä—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤

### 2. –û—Ä–∞–Ω–∂–µ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã - –î–æ–º–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
- `has_active_ads: true`
- `active_ads_count > 0`
- –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–æ–º–∞

### 3. –°–µ—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã - –î–æ–º–∞ —Ç–æ–ª—å–∫–æ —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
- `has_active_ads: false`
- `active_ads_count = 0`
- –ú–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ, –Ω–æ –≤—Å–µ –µ—â–µ –ø–æ–ª–µ–∑–Ω—ã–µ


## –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞
–û—Ä–∞–Ω–∂–µ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–æ–º–æ–≤ –º–æ–≥—É—Ç –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ –æ–¥–Ω–æ–º—É –∞–¥—Ä–µ—Å—É.

### –†–µ—à–µ–Ω–∏–µ (API-level)

1. GET /map/ads-in-bounds (—Å—Ç—Ä–æ–∫–∞ 978) - –æ—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è
  –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞—Ä—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: north, south, east, west, rooms, maxPrice, minArea,
  minKitchenArea, limit
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é public.get_ads_in_bounds()
  2. GET /map/houses-filtered (—Å—Ç—Ä–æ–∫–∞ 553) - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–º–æ–≤ —Å
  –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞—Ä—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    - –¢–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + flatId –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
  3. GET /map/houses-in-bounds (—Å—Ç—Ä–æ–∫–∞ 402) - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–º–æ–≤ —Å
  –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞—Ä—Ç—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–µ/–ø–ª–æ—â–∞–¥–∏
  4. GET /map/house-ads (—Å—Ç—Ä–æ–∫–∞ 169) - –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ
  –¥–æ–º–∞ –ø–æ houseId

    –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ:

  1. –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ nearby-ads-block.tsx:28-57:
    - –ò—â—É—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è CIAN –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
    - –ë–µ—Ä–µ—Ç—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π
    - –ò–∑ –Ω–µ–≥–æ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –ø–ª–æ—â–∞–¥–∏: totalArea * 0.9 –∏ kitchenArea * 0.9
  2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ nearby-ads-block.tsx:62-67:
  const [mapFilters, setMapFilters] = useState<FlatFilters>(() => ({
    rooms: nearbyFilters?.rooms || flat.rooms || 3,
    maxPrice: nearbyFilters?.maxPrice || nearbyFilters?.currentPrice || 50000000,
    minArea: nearbyFilters?.minArea || baseAreaValues.minArea,
    minKitchenArea: nearbyFilters?.minKitchenArea || baseAreaValues.minKitchenArea,
  }))
  3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–∏–ª—å—Ç—Ä–∞ nearby-ads-filter.tsx:32-38:
    - –ü–æ–ª—É—á–∞–µ—Ç currentFilters –∏ —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è –≤–≤–æ–¥–∞
    - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ò—Å–∫–∞—Ç—å –µ—â–µ" –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è onSearch
  4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ nearby-ads-block.tsx:70-91:
    - –û–±–Ω–æ–≤–ª—è–µ—Ç mapFilters –¥–ª—è –∫–∞—Ä—Ç—ã
    - –í—ã–∑—ã–≤–∞–µ—Ç onSearchWithFilters –¥–ª—è –ø–æ–∏—Å–∫–∞

  –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
  1. nearbyFilters (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –∏–∑–≤–Ω–µ)
  2. –î–∞–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã (flat.rooms)
  3. –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö CIAN –æ–±—ä—è–≤–ª–µ–Ω–∏–π
  4. Fallback –∑–Ω–∞—á–µ–Ω–∏—è (50000000 –¥–ª—è —Ü–µ–Ω—ã, 3 –¥–ª—è –∫–æ–º–Ω–∞—Ç)


1. **–í API endpoint `/map/houses-in-bounds`:**
   ```sql
   -- –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
   SELECT address FROM users.user_flats WHERE id = ${flatId}

   -- –ò—Å–∫–ª—é—á–∞–µ–º –¥–æ–º–∞ —Å —Ç–µ–º –∂–µ –∞–¥—Ä–µ—Å–æ–º
   WHERE house.address !== currentFlatAddress
   ```

2. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ API-level —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
   - –õ–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞
   - –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
   - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

### `NearbyMapComponent`
–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã —Å Leaflet.

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∞–¥—Ä–µ—Å–∞
- –†–∞–∑–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
- –õ–µ–≥–µ–Ω–¥–∞ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤

### `NearbyMap`
Wrapper –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- Server-side rendering (SSR) —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –ö–ª–∏–∫–∞ –ø–æ –¥–æ–º–∞–º –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏

## Workflow —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ–π

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–¥—Ä–µ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü–æ–ª—É—á–∞—é—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —á–µ—Ä–µ–∑ `/map/address-coordinates`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã

2. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–æ–≤:**
   - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/map/houses-in-bounds`
   - API –∏—Å–∫–ª—é—á–∞–µ—Ç –¥–æ–º–∞ –ø–æ –∞–¥—Ä–µ—Å—É —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
   - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –º–∞—Ä–∫–µ—Ä—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏

3. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
   - –ö–ª–∏–∫ –ø–æ –¥–æ–º—É ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ `/map/house-ads`
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –õ–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–º–æ–≤ (500)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∞–¥—Ä–µ—Å–æ–≤
- Debounce –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (20 —à—Ç)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –¥–æ–º–æ–≤
- –°—á–µ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ API
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–¢–æ—á–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:** –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –º–æ–≥—É—Ç –Ω–µ —Å—Ä–∞–∑—É –æ—Ç—Ä–∞–∂–∞—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ

## –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (Preview + Bounds)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —ç–∫—Ä–∞–Ω–∞ –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω—ã **–≤—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã**, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —Ñ–∏–ª—å—Ç—Ä–∞–º, –≤ preview –æ–∫–Ω–µ —Å–ø—Ä–∞–≤–∞.

### 1. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

#### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã)
–ó–∞–∫—Ä–µ–ø–ª–µ–Ω—ã —Å–≤–µ—Ä—Ö—É, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç** - –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞** - –º–µ–Ω—å—à–µ —Ü–µ–Ω—ã —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å** - 95% –æ—Ç –ø–ª–æ—â–∞–¥–∏ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏** - —Ä–∞–≤–Ω–∞ –∏–ª–∏ –±–æ–ª—å—à–µ –∫—É—Ö–Ω–∏ —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã

#### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã (–æ–±–ª–∞—Å—Ç—å –∫–∞—Ä—Ç—ã)
–ò–∑–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã:
- **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ bounds** - —Å–µ–≤–µ—Ä/—é–≥/–≤–æ—Å—Ç–æ–∫/–∑–∞–ø–∞–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
- **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ pan/zoom –∫–∞—Ä—Ç—ã
- **Debounced –∑–∞–ø—Ä–æ—Å—ã** (300-500ms) –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 2. API –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ bounds

#### –ù–æ–≤—ã–π endpoint: `/map/ads-in-bounds`
```typescript
GET /map/ads-in-bounds
Query params:
- north: number        // —Å–µ–≤–µ—Ä–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã
- south: number        // —é–∂–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã
- east: number         // –≤–æ—Å—Ç–æ—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã
- west: number         // –∑–∞–ø–∞–¥–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã
- rooms: number        // –º–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
- maxPrice: number     // –º–∞–∫—Å. —Ü–µ–Ω–∞
- minArea?: number     // –º–∏–Ω. –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å
- minKitchenArea?: number // –º–∏–Ω. –ø–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏
- limit?: number       // –ª–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
```

#### Database Function
```sql
CREATE OR REPLACE FUNCTION public.get_ads_in_bounds(
    p_north real,
    p_south real,
    p_east real,
    p_west real,
    p_rooms integer,
    p_max_price bigint,
    p_min_area real DEFAULT NULL,
    p_min_kitchen_area real DEFAULT NULL,
    p_limit integer DEFAULT 100
)
RETURNS TABLE(
    price bigint,
    lat real,
    lng real,
    rooms smallint,
    area numeric,
    kitchen_area numeric,
    floor smallint,
    total_floors smallint,
    house_id integer,
    url text,
    updated_at timestamp,
    distance_m integer
)
```

### 3. Preview –æ–∫–Ω–æ (–ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å)

#### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–∏—Ö bounds + —Ñ–∏–ª—å—Ç—Ä—ã –∫–≤–∞—Ä—Ç–∏—Ä—ã
- **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ bounds –∫–∞—Ä—Ç—ã
- **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: –ü–æ —Ü–µ–Ω–µ (–æ—Ç –¥–µ—à–µ–≤—ã—Ö –∫ –¥–æ—Ä–æ–≥–∏–º)
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª**: –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–∞—Ö

#### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–∞—Ä—Ç–æ–π
- **Hover —ç—Ñ—Ñ–µ–∫—Ç—ã**: –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ - –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
- **–ö–ª–∏–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ - —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
- **–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å**: –ö–ª–∏–∫ –Ω–∞ –º–∞—Ä–∫–µ—Ä ‚Üí –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ preview —Å–ø–∏—Å–∫–µ

### 4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Frontend

#### Hook –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
```typescript
interface MapBounds {
  north: number;
  south: number;
  east: number;
  west: number;
}

interface FlatFilters {
  rooms: number;
  maxPrice: number;
  minArea?: number;
  minKitchenArea?: number;
}

const useMapAdsFilter = (flatFilters: FlatFilters) => {
  const [bounds, setBounds] = useState<MapBounds | null>(null);
  const [ads, setAds] = useState([]);
  const [loading, setLoading] = useState(false);

  // Debounced –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ bounds
  const debouncedLoadAds = useCallback(
    debounce(async (bounds: MapBounds) => {
      setLoading(true);
      try {
        const response = await fetch(`/api/map/ads-in-bounds?${new URLSearchParams({
          ...bounds,
          ...flatFilters
        })}`);
        const data = await response.json();
        setAds(data.ads || []);
      } finally {
        setLoading(false);
      }
    }, 300),
    [flatFilters]
  );

  useEffect(() => {
    if (bounds) {
      debouncedLoadAds(bounds);
    }
  }, [bounds, debouncedLoadAds]);

  return { ads, loading, setBounds };
};
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Preview –ø–∞–Ω–µ–ª–∏
```typescript
interface AdsPreviewProps {
  ads: AdInterface[];
  loading: boolean;
  onAdHover: (ad: AdInterface | null) => void;
  onAdClick: (ad: AdInterface) => void;
}

const AdsPreview: React.FC<AdsPreviewProps> = ({
  ads, loading, onAdHover, onAdClick
}) => {
  return (
    <div className="ads-preview">
      <div className="filters-display">
        {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */}
      </div>

      {loading && <div className="loading-spinner" />}

      <VirtualizedList
        items={ads}
        renderItem={(ad) => (
          <AdItem
            ad={ad}
            onHover={() => onAdHover(ad)}
            onLeave={() => onAdHover(null)}
            onClick={() => onAdClick(ad)}
          />
        )}
      />
    </div>
  );
};
```
fix
  ‚úÖ 1. Fixed map filter logic to match "–û–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏" filter behavior

  - Added externalFilters prop to MapWithPreview component
  - Implemented filter synchronization between NearbyAdsFilter form and map preview
  - Map preview now uses the same filters as the "–û–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏" block

  ‚úÖ 2. Implemented automatic ad status updates via Python API for cian ads

  - Created new API endpoint /map/update-ads-statuses in map.ts
  - Added automatic status update functionality to use-map-ads-filter.ts hook
  - Status updates trigger automatically as a second step after loading data from database (no manual buttons as requested)
  - Updates run after 500ms delay to allow initial data to display first

### 5. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö currentFlat –∏–∑ `users.user_flats`
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (rooms, price, areas)
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –∞–¥—Ä–µ—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã

2. **–ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ bounds –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
   - –ó–∞–ø—Ä–æ—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ preview –ø–∞–Ω–µ–ª–∏

3. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**:
   - –ü—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ bounds ‚Üí –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π
   - Hover/click —Å–æ–±—ã—Ç–∏—è –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ–π –∏ preview
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

### 6. UI/UX —É–ª—É—á—à–µ–Ω–∏—è

#### –§–∏–ª—å—Ç—Ä—ã badges (–≤–µ—Ä—Ö —ç–∫—Ä–∞–Ω–∞)
```typescript
<div className="filters-badges">
  <Badge variant="primary">–ö–æ–º–Ω–∞—Ç: {filters.rooms}+</Badge>
  <Badge variant="price">–î–æ: {formatPrice(filters.maxPrice)}</Badge>
  <Badge variant="area">–ü–ª–æ—â–∞–¥—å: {filters.minArea}+ –º¬≤</Badge>
  <Badge variant="kitchen">–ö—É—Ö–Ω—è: {filters.minKitchenArea}+ –º¬≤</Badge>
</div>
```

#### Loading —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –°–ø–∏–Ω–Ω–µ—Ä –≤ preview –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- Skeleton loader –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã

#### Empty —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –°–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏"
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤
- –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"

### 7. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è**: React-window –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Query cache –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Debouncing**: 300ms –¥–ª—è bounds –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**: –ü–æ 100 –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∑–∞ –∑–∞–ø—Ä–æ—Å
- **–ì–µ–æ–∏–Ω–¥–µ–∫—Å—ã**: PostGIS –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–æ–º–æ–≤ (—è–Ω–≤–∞—Ä—å 2025)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º–∞
–≠–Ω–¥–ø–æ–∏–Ω—Ç `/map/houses-in-bounds` –¥–µ–ª–∞–ª –æ—Ç–¥–µ–ª—å–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–∞ –∏–∑ PostGIS, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –º–µ–¥–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–º–æ–≤.

#### –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ in-memory –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–æ–º–æ–≤ –≤ API:

```typescript
// –ö—ç—à –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–æ–º–æ–≤ –≤ –ø–∞–º—è—Ç–∏
const houseCoordinatesCache = new Map<number, { lat: number; lng: number }>()

// –§—É–Ω–∫—Ü–∏—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function getHouseCoordinates(houseIds: number[]): Promise<Map<number, { lat: number; lng: number }>> {
  const result = new Map<number, { lat: number; lng: number }>()
  const uncachedIds = houseIds.filter((id) => !houseCoordinatesCache.has(id))

  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  for (const id of houseIds) {
    const cached = houseCoordinatesCache.get(id)
    if (cached) {
      result.set(id, cached)
    }
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ–∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∞–∫–µ—Ç–æ–º
  if (uncachedIds.length > 0) {
    const batchResult = await db.execute(sql`
      SELECT
        house_id,
        system.ST_Y(system.ST_Transform(centroid_utm, 4326)) as lat,
        system.ST_X(system.ST_Transform(centroid_utm, 4326)) as lng
      FROM "system".moscow_geo
      WHERE house_id = ANY(${uncachedIds})
    `)

    // –ö—ç—à–∏—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const rows = Array.isArray(batchResult) ? batchResult : (batchResult as any).rows || []
    for (const row of rows) {
      const coords = { lat: row.lat, lng: row.lng }
      houseCoordinatesCache.set(row.house_id, coords)
      result.set(row.house_id, coords)
    }
  }

  return result
}
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `/map/houses-in-bounds`
–û–±–Ω–æ–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:

```typescript
// –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ house_id —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
const houseRows = await db.execute(sql`
  SELECT * FROM public.get_houses_in_bounds(...)
`)

// –ò–∑–≤–ª–µ–∫–∞–µ–º house_id –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
const houseIds = houseRows.map((row: any) => row.house_id)

// –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –∫—ç—à–∞ (–ø–∞–∫–µ—Ç–Ω–æ –¥–ª—è –Ω–µ–∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)
const coordinates = await getHouseCoordinates(houseIds)

// –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ–º–æ–≤ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
const houses = houseRows.map((house: any) => {
  const coords = coordinates.get(house.house_id)
  return {
    ...house,
    lat: coords?.lat || null,
    lng: coords?.lng || null,
  }
}).filter((house: any) => house.lat && house.lng)
```

#### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**: ~12 –ú–ë –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–æ–≤ –ú–æ—Å–∫–≤—ã (~1M –¥–æ–º–æ–≤)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: –í —Ä–∞–∑—ã –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- **–ö—ç—à**: –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π (–¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–æ LRU cache –∏–ª–∏ Redis

#### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è —Ä–æ—Å—Ç–∞
- **LRU cache**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
- **TTL cache**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
- **Redis**: –í–Ω–µ—à–Ω–∏–π –∫—ç—à –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã (—è–Ω–≤–∞—Ä—å 2025)

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã

#### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –∫–≤–∞—Ä—Ç–∏—Ä—ã 20 –Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É 18) –∫–∞—Ä—Ç–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∏–∑-–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è `mapCenter`.

#### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω `useEffect` –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –ø—Ä–∏ —Å–º–µ–Ω–µ `flatId`:

```typescript
// Reset map center when flatId changes
useEffect(() => {
  setMapCenter(null)
}, [flatId])
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç
–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏ –∫–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ.

## –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (—è–Ω–≤–∞—Ä—å 2025)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

#### –ü—Ä–æ–±–ª–µ–º–∞
–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞–ª–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–∞–ª –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞.

#### –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π:

```typescript
// –ù–æ–≤—ã–π —Ö—É–∫ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
export const useMapCache = () => {
  // –ö—ç—à –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Å TTL = 5 –º–∏–Ω—É—Ç
  const [cache, setCache] = useState<CachedMapData | null>(null)

  // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
  const fetchMapData = useCallback(async (bounds: MapBounds) => {
    const expandedBounds = { /* +10% –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */ }
    const response = await fetch(`/map/ads?${expandedBounds}&limit=1000`)
    // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
  }, [])

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
  const getFilteredData = useCallback(async (bounds, filters) => {
    if (isCacheValid(bounds)) {
      return {
        houses: filterAndColorHouses(cache.houses, filteredAds, bounds),
        ads: filterAds(cache.ads, filters)
      }
    }
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
  }, [cache])
}
```

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã:**
- `apps/web/src/hooks/use-map-cache.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ö—É–∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- `apps/web/src/components/map-filter-demo.tsx` - –¥–µ–º–æ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:** API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ (+1–∫–º padding)
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Å TTL = 5 –º–∏–Ω—É—Ç
3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
4. **–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤:**
   - üü† –û—Ä–∞–Ω–∂–µ–≤—ã–µ - –¥–æ–º–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ —Å—Ä–µ–¥–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö
   - ‚ö™ –°–µ—Ä—ã–µ - –¥–æ–º–∞ —Ç–æ–ª—å–∫–æ —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
5. **Invalidation:** –ü—Ä–∏ —Å–º–µ–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã –∫—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –æ–±—ä—è–≤–ª–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –¥–æ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å —Å–µ—Ä—ã–º–∏, —Ö–æ—Ç—è —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.

**–ü—Ä–∏—á–∏–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

1. **API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø–æ–ª–µ `is_actual`:**
```sql
-- –ë—ã–ª–æ (–æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ is_actual):
SELECT fh.price, fh.rooms, fh.floor, fh.house_id, fh.url, fh.time_source_updated as updated_at

-- –°—Ç–∞–ª–æ:
SELECT fh.price, fh.rooms, fh.floor, fh.house_id, fh.url, fh.time_source_updated as updated_at, fh.is_actual
```

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
```typescript
// –ë—ã–ª–æ (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
const hasActiveAds = Boolean(house.has_active_ads === true)

// –°—Ç–∞–ª–æ (–≥–∏–±–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
const hasActiveAds = Boolean(house.has_active_ads || house.active_ads_count > 0)
```

3. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–æ–≤ –±–µ–∑ –ø–æ–ª–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
```typescript
// –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–º–æ–≤ –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:
const activeAds = ads.filter(ad => {
  return ad.is_active === true || ad.is_active === 1 || ad.is_active === '1'
})

return {
  house_id: houseId,
  has_active_ads: activeAds.length > 0,
  active_ads_count: activeAds.length,
  total_ads_count: ads.length,
  // ...
}
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

**UX —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
- üìä –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫—ç—à–∞
- üéØ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- üöÄ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
- üíæ –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç

**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- üõ°Ô∏è Fallback –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ñ–ª–∞–≥–æ–≤
- üîç –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚è∞ TTL –∫—ç—à–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä (`/my-flats/[flatId]`) —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `nearby-map-component.tsx`. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ –≤—Å–µ–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ API.

## –†–∞–∑–≤–∏—Ç–∏–µ

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞—Ä—Ç—ã –≤ localStorage
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ú–∏–≥—Ä–∞—Ü–∏—è –∫—ç—à–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ Redis –¥–ª—è production
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è